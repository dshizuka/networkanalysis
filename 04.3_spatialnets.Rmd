---
title: "4.3 Intro to Spatial Networks"
author: "Dai Shizuka"
date: "7/10/2018"
output: 
  html_document:
    toc: yes
    toc_depth: 3
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(fig.width=6, fig.height=4) 
set.seed(2)
```

Spatial networks

With spatial networks, the nodes represent spatial locations and the edges represent connections between those locations, e.g., *habitat connectivity* (‘ landscape connectivity networks’: Urban & Keitt 2001, Urban et al. 2009), *movements of individuals* (‘movement networks’: Jacoby & Freeman 2016), *genetic covariance among populations* (‘population graphs’: Dyer & Nason 2004, Dyer 2015), *migration pathways* (‘migratory flow networks’: Taylor & Norris 2010). Such networks of connectivity between populations are important in a variety of fields including conservation biology, population genetics, evolution and metapopulation ecology.

##4.3.1 Spatial network of *Lophocereus schottii*

![*Lophocereus schottii*](https://www.dropbox.com/s/bvclexwgv2zktur/L.schottii.jpg?dl=1)

To explore this type of data, we will be demonstrating the construction of space-based networks using a dataset on genetic connectivity (‘population graph’) of the cactus *Lophocereus schottii* from Dyer & Nason (2004). We will be using an R package called ‘popgraph’, written by Rodney Dyer. A nice tutorial is available online (http://dyerlab.github.io/popgraph/), and the codes here are mostly adapted from this site.

First, we will import an adjacency matrix of genetic connectivity among sites in L. schottii (Dyer & Nason 2004). Nason et al. (2002) assayed 29 polymorphic allozyme loci from 948 individual cacti in 21 populations. This data was converted to a 21 x 21 genetic distance matrix. Then the pairs of populations that were (using a method called edge exclusion deviance; see Dyer and Nason 2004 for details). In the resulting network (i.e., ‘population graph’), sites are connected by an edge if they are genetically ‘significantly similar’ (i.e., there is gene flow).

```{r message=F}
library(igraph)
library(popgraph)
library(ggmap)
```

Let’s read the data and take a look (output not shown here):
```{r results='hide'}
lopnet=as.matrix(read.csv("https://dshizuka.github.io/networkanalysis/SampleData/lopho_network.csv", header=T, row.names=1)) #From Dyer et al. 2004
lopnet
```

Now, let’s convert this into a graph object and plot it:
```{r}
g=graph_from_adjacency_matrix(lopnet, mode="undirected") 
plot(g)
```

Again, in this network, each node represents a population and the edges connect populations that are significantly similar genetically.

##4.3.2 Using spatial data to plot networks

Now, let’s now display this network using the actual locations of the nodes. To do this, we will read in a second dataset that includes the latitude/longitude coordinates of each node as well as a “region” variable indicating whether the population is in Sonora or Baja state of Mexico. This data is from Table 1 in Nason et al. (2002).

```{r}
locations=read.csv("https://dshizuka.github.io/networkanalysis/SampleData/lopho_locations.csv") 
head(locations)
```

We can use these coordinates to plot the spatial network. We won’t worry about specific projection methods for converting coordinates to 2D. We can do this by creating a 2-column matrix of x- and y-coordinates and using this as the ‘layout’, which we can specify when plotting the network. While we’re at it, we will also color-code the nodes based on region:

```{r}
#create a two-column matrix of x- and y-coordinates
V(g)$x=locations[match(V(g)$name, locations$Population),"Long"]
V(g)$y=locations[match(V(g)$name, locations$Population),"Lat"]
l=matrix(c(V(g)$x, V(g)$y), ncol=2)

# color-code nodes by region
regions=locations[match(V(g)$name, locations$Population),"Region"]
V(g)$color=c("tomato", "turquoise2")[as.numeric(regions)]
```

Now, let’s compare what the networks look like when using this ‘spatial layout’, compared to a force-directed layout (Fruchterman-Reingold), which is the default layout in igraph.

```{r}
par(mfrow=c(1,2), mar=c(2,2,2,2))
plot(g, layout=l, main="Spatial Layout")
plot(g, layout=layout_with_fr(g), main="Force-directed layout")
```

Comparing these network layouts, one thing pops out: one population (“SenBas”) is located in Sonora, but it clusters genetically with the Baja California populations. Geographically, it doesn’t seem to be particularly closer to the Baja populations, so what gives? It would be nice to ve able to see the underlying geographic features here...

##4.3.3 Making it a lot prettier using popgraph
Now, let’s make this spatial network much nicer using the ‘popgraph’ package. This will allow us to make a figure that overlays this network on top of a satellite image. Beware: this package uses the package `ggplot2` for graphics, so the syntax may be unfamiliar to some of you.

```{r}
library(popgraph)
library(ggmap)
library(ggplot2)
location = c( mean(V(g)$x), mean(V(g)$y))
map = get_map(location,maptype="satellite", zoom=6) #use ggmap to get a satellite image of the study area.
p = ggmap( map ) #plot will include this image
p = p + geom_edgeset(aes(x=x, y=y), g, color="white") #plot will also include the network edges, in white
p = p + geom_nodeset(aes(x=x, y=y, color=color), g, size=6) #plot will also include the network nodes, color-coded by region
p #plot color
```